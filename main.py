import os
import logging
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler
from database import db
from game import game
from csv_manager import csv_manager
from utils import log_action, ensure_directories
from config import TELEGRAM_TOKEN, TELEGRAM_ADMIN_ID

load_dotenv()
ensure_directories()

# Setup logging
logging.basicConfig(
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            level=logging.INFO
)
logger = logging.getLogger(__name__)

# ============ STATES ============
WAITING_NAME = 1

# ============ COMMAND HANDLERS ============

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handler /start"""
        user_id = update.effective_user.id
            player = db.get_player(user_id)
                
                    if player:
                            log_action(user_id, "start", "Player sudah ada")
                                    await update.message.reply_text(
                                                    f"üëã Selamat datang kembali, {player['nama']}!\n{game.format_status(player)}",
                                                                parse_mode="Markdown"
                                    )
                                        else:
                                                log_action(user_id, "start", "Player baru")
                                                        await update.message.reply_text(
                                                                        "üéÆ **Selamat datang di oWo RPG!**\n\nSiapa nama karaktermu? (minimal 3 karakter)"
                                                        )
                                                                context.user_data['waiting_name'] = True
                                                                        return WAITING_NAME

                                                                        async def handle_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                            """Handle input nama"""
                                                                                user_id = update.effective_user.id
                                                                                    nama = update.message.text.strip()
                                                                                        
                                                                                            if len(nama) < 3:
                                                                                                    await update.message.reply_text("‚ùå Nama minimal 3 karakter!")
                                                                                                            return WAITING_NAME
                                                                                                                
                                                                                                                    if len(nama) > 20:
                                                                                                                            await update.message.reply_text("‚ùå Nama maksimal 20 karakter!")
                                                                                                                                    return WAITING_NAME
                                                                                                                                        
                                                                                                                                            player = db.create_player(user_id, nama)
                                                                                                                                                log_action(user_id, "create_player", f"Nama: {nama}")
                                                                                                                                                    
                                                                                                                                                        await update.message.reply_text(
                                                                                                                                                                    f"‚úÖ Karakter '{nama}' berhasil dibuat!\n{game.format_status(player)}",
                                                                                                                                                                            parse_mode="Markdown"
                                                                                                                                                        )
                                                                                                                                                            return ConversationHandler.END

                                                                                                                                                            async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                """Handler /status"""
                                                                                                                                                                    user_id = update.effective_user.id
                                                                                                                                                                        player = db.get_player(user_id)
                                                                                                                                                                            
                                                                                                                                                                                if not player:
                                                                                                                                                                                        await update.message.reply_text("‚ùå Buat karakter dulu! /start")
                                                                                                                                                                                                return
                                                                                                                                                                                                    
                                                                                                                                                                                                        log_action(user_id, "status", f"Level: {player['level']}")
                                                                                                                                                                                                            await update.message.reply_text(game.format_status(player), parse_mode="Markdown")

                                                                                                                                                                                                            async def jelajah(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                """Handler /jelajah"""
                                                                                                                                                                                                                    user_id = update.effective_user.id
                                                                                                                                                                                                                        player = db.get_player(user_id)
                                                                                                                                                                                                                            
                                                                                                                                                                                                                                if not player:
                                                                                                                                                                                                                                        await update.message.reply_text("‚ùå Buat karakter dulu! /start")
                                                                                                                                                                                                                                                return
                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                        log_action(user_id, "jelajah", f"Level: {player['level']}")
                                                                                                                                                                                                                                                            result = game.jelajah(user_id)
                                                                                                                                                                                                                                                                await update.message.reply_text(result, parse_mode="Markdown")

                                                                                                                                                                                                                                                                async def battle(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                    """Handler /battle"""
                                                                                                                                                                                                                                                                        user_id = update.effective_user.id
                                                                                                                                                                                                                                                                            player = db.get_player(user_id)
                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                    if not player:
                                                                                                                                                                                                                                                                                            await update.message.reply_text("‚ùå Buat karakter dulu! /start")
                                                                                                                                                                                                                                                                                                    return
                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            log_action(user_id, "battle", f"Level: {player['level']}")
                                                                                                                                                                                                                                                                                                                result = game.battle(user_id)
                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(result, parse_mode="Markdown")

                                                                                                                                                                                                                                                                                                                    async def inventory(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                        """Handler /inventory"""
                                                                                                                                                                                                                                                                                                                            user_id = update.effective_user.id
                                                                                                                                                                                                                                                                                                                                player = db.get_player(user_id)
                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                        if not player:
                                                                                                                                                                                                                                                                                                                                                await update.message.reply_text("‚ùå Buat karakter dulu! /start")
                                                                                                                                                                                                                                                                                                                                                        return
                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                log_action(user_id, "inventory", f"Items: {len(db.get_inventory(user_id))}")
                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(game.format_inventory(player), parse_mode="Markdown")

                                                                                                                                                                                                                                                                                                                                                                    async def ranking(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                                                        """Handler /ranking"""
                                                                                                                                                                                                                                                                                                                                                                            log_action(update.effective_user.id, "ranking", "Lihat ranking")
                                                                                                                                                                                                                                                                                                                                                                                text = game.get_ranking_text()
                                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(text, parse_mode="Markdown")

                                                                                                                                                                                                                                                                                                                                                                                    async def shop(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                                                                        """Handler /shop"""
                                                                                                                                                                                                                                                                                                                                                                                            log_action(update.effective_user.id, "shop", "Lihat shop")
                                                                                                                                                                                                                                                                                                                                                                                                text = game.get_shop_text()
                                                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(text, parse_mode="Markdown")

                                                                                                                                                                                                                                                                                                                                                                                                    async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                                                                                        """Handler /help"""
                                                                                                                                                                                                                                                                                                                                                                                                            help_text = """
                                                                                                                                                                                                                                                                                                                                                                                                            üéÆ **COMMAND oWo RPG**

                                                                                                                                                                                                                                                                                                                                                                                                            /start - Mulai game
                                                                                                                                                                                                                                                                                                                                                                                                            /status - Lihat status
                                                                                                                                                                                                                                                                                                                                                                                                            /jelajah - Jelajahi dunia
                                                                                                                                                                                                                                                                                                                                                                                                            /battle - Lawan monster
                                                                                                                                                                                                                                                                                                                                                                                                            /inventory - Lihat item
                                                                                                                                                                                                                                                                                                                                                                                                            /ranking - Lihat top 10
                                                                                                                                                                                                                                                                                                                                                                                                            /shop - Lihat toko
                                                                                                                                                                                                                                                                                                                                                                                                            /beli [item] - Beli item
                                                                                                                                                                                                                                                                                                                                                                                                            /jual [item] - Jual item
                                                                                                                                                                                                                                                                                                                                                                                                            /gunakan [item] - Pakai item
                                                                                                                                                                                                                                                                                                                                                                                                            /help - Bantuan

                                                                                                                                                                                                                                                                                                                                                                                                            üì¶ **ITEM YANG BISA DIBELI:**
                                                                                                                                                                                                                                                                                                                                                                                                            roti, ramuan_hidup, pedang_besi, perisai_kayu, pedang_kilat, mahkota_emas, kristal_mistis, pedang_naga

                                                                                                                                                                                                                                                                                                                                                                                                            ‚öîÔ∏è **CARA BERMAIN:**
                                                                                                                                                                                                                                                                                                                                                                                                            1. Buat karakter dengan /start
                                                                                                                                                                                                                                                                                                                                                                                                            2. Jelajahi dunia dengan /jelajah
                                                                                                                                                                                                                                                                                                                                                                                                            3. Lawan monster dengan /battle
                                                                                                                                                                                                                                                                                                                                                                                                            4. Kumpulkan item dan koin
                                                                                                                                                                                                                                                                                                                                                                                                            5. Naik level dan jadi lebih kuat!
                                                                                                                                                                                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                                                                                                                                                                                await update.message.reply_text(help_text, parse_mode="Markdown")

                                                                                                                                                                                                                                                                                                                                                                                                                async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                                                                                                    """Handle pesan teks"""
                                                                                                                                                                                                                                                                                                                                                                                                                        user_id = update.effective_user.id
                                                                                                                                                                                                                                                                                                                                                                                                                            text = update.message.text.strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                    # Tunggu input nama
                                                                                                                                                                                                                                                                                                                                                                                                                                        if context.user_data.get('waiting_name'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                return await handle_name(update, context)
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Handle command dengan parameter
                                                                                                                                                                                                                                                                                                                                                                                                                                                            if text.startswith("/beli "):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    item_name = text.replace("/beli ", "").strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            result = game.beli_item(user_id, item_name)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    log_action(user_id, "beli", f"Item: {item_name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await update.message.reply_text(result, parse_mode="Markdown")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif text.startswith("/jual "):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            item_name = text.replace("/jual ", "").strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    result = game.jual_item(user_id, item_name)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            log_action(user_id, "jual", f"Item: {item_name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(result, parse_mode="Markdown")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif text.startswith("/gunakan "):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    item_name = text.replace("/gunakan ", "").strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            result = game.gunakan_item(user_id, item_name)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    log_action(user_id, "gunakan", f"Item: {item_name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await update.message.reply_text(result, parse_mode="Markdown")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await update.message.reply_text("‚ùì Command tidak dikenal. Ketik /help untuk bantuan")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async def admin_export(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """Handler /export (admin only)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    user_id = update.effective_user.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if user_id != TELEGRAM_ADMIN_ID:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text("‚ùå Anda tidak memiliki akses")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            csv_manager.export_all_to_csv()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text("‚úÖ Database berhasil di-export ke CSV")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            log_action(user_id, "export", "Database exported")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await update.message.reply_text(f"‚ùå Error: {str(e)}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async def admin_import(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Handler /import (admin only)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                user_id = update.effective_user.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if user_id != TELEGRAM_ADMIN_ID:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await update.message.reply_text("‚ùå Anda tidak memiliki akses")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        csv_manager.import_all_from_csv()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await update.message.reply_text("‚úÖ CSV berhasil di-import ke database")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        log_action(user_id, "import", "CSV imported")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(f"‚ùå Error: {str(e)}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """Handler /stats (admin only)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            user_id = update.effective_user.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if user_id != TELEGRAM_ADMIN_ID:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await update.message.reply_text("‚ùå Anda tidak memiliki akses")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            total_players = db.get_total_players()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                total_battles = db.get_total_battles()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    total_transactions = db.get_total_transactions()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            stats_text = f"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            üìä **STATISTIK SERVER**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            üë• Total Pemain: {total_players}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ‚öîÔ∏è Total Battle: {total_battles}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            üí∞ Total Transaksi: {total_transactions}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await update.message.reply_text(stats_text, parse_mode="Markdown")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        log_action(user_id, "stats", f"Players: {total_players}, Battles: {total_battles}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ============ MAIN ============

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def main():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Main function"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                app = Application.builder().token(TELEGRAM_TOKEN).build()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Conversation handler untuk input nama
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            conv_handler = ConversationHandler(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        entry_points=[CommandHandler("start", start)],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                states={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                WAITING_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_name)]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fallbacks=[CommandHandler("start", start)]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Command handlers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        app.add_handler(conv_handler)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.add_handler(CommandHandler("status", status))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                app.add_handler(CommandHandler("jelajah", jelajah))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    app.add_handler(CommandHandler("battle", battle))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        app.add_handler(CommandHandler("inventory", inventory))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.add_handler(CommandHandler("ranking", ranking))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                app.add_handler(CommandHandler("shop", shop))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    app.add_handler(CommandHandler("help", help_command))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        app.add_handler(CommandHandler("export", admin_export))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.add_handler(CommandHandler("import", admin_import))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                app.add_handler(CommandHandler("stats", admin_stats))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Message handler
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Buat CSV files
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        csv_manager.create_all_csv()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("ü§ñ Bot oWo RPG sedang berjalan...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("üìä Database: database/owo_game.db")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("üìÅ CSV Path: data/")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                app.run_polling()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    main()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                        )
                                                        )
                                    )
)